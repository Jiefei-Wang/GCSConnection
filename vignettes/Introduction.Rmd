---
title: "Introduction"
author: 
- name: Jiefei Wang
  affiliation: Roswell Park Comprehensive Cancer Center, Buffalo, NY
date: "`r Sys.Date()`"
output:
    BiocStyle::html_document:
        toc: true
        toc_float: true
vignette: >
  %\VignetteIndexEntry{quickStart}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
package: GCSConnection
---


```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
library(GCSConnection)
```
# Credentials
## Auto authentication
You need to have a service account credentials to authenticate 
with Google Cloud Storage API. The credentials determines which data sources
are accessable to you. Please follow the instructions on [Google
Authentication][] to create your credentials file and download it to
your local machine. The package will search for the credentials file from
the environment variable `GOOGLE_APPLICATION_CREDENTIALS` when it is
loaded. If it fails to find the credentials, it will look for the
environment variable `GCS_AUTH_FILE` instead. If both environment
variables are empty, you will only be able to access public data. If you set the environment variables after the package is loaded, you can redo the authentication by `gcs_cloud_auth()`.

## Manual authentication
The function `gcs_cloud_auth` provides two ways to authenticate with Google Cloud. When you have a service account credentials, you can authenticate with Google Cloud by calling `gcs_cloud_auth(credentials_file_path)`. The second method is to get credentials from [Cloud SDK][]. The package is able to interact with the command-line tool gcloud. Once the account has been set in the `gcloud` program, the package can be authenticated by `gcs_cloud_auth(gcloud = TRUE)`. By default, the package will use the first account in gcloud to authenticate with Google. If there are multiple accounts in gcloud, you can switch the account by `gcs_cloud_auth(gcloud = TRUE, email = "your email address")`. 

## Anouymous access
Not all the cloud buckets require a credentials to access. You can read public data without authenticating with Google. By default, if the package fails to find the credentials from the environment variables, the package will use anouymous access method to query data from google cloud. Otherwise, you can switch to the anouymous mode by calling `gcs_cloud_auth(json_file = NULL)`. An error message will be shown if the access is denied.



Once the credentials is set, you can check your token and authenticate type via:
```{r}
gcs_get_cloud_auth()
```

[Cloud SDK]: https://cloud.google.com/sdk/

[Google Authentication]: https://cloud.google.com/docs/authentication/production


# Connections

Creating a connection to a file on a Google Cloud bucket is simple,
simply provide the URL using . Below is an example to create a read
connection with a public dataset on Google Cloud Platform.
```{r}
file <- "gs://genomics-public-data/NA12878.chr20.sample.DeepVariant-0.7.2.vcf"
con <- gcs_connection(description = file, open = "rp")
readLines(con, n = 4L)
close(con)
```
Note that you do not need a credentials for accessing the public data.
the character "rp" in the parameter `open` is an abbreviation of read and public respectively. See `?gcs_connection` for more details.

It is also possible to specifying file and bucket name
individually. For example:
```{r}
file_name <- "NA12878.chr20.sample.DeepVariant-0.7.2.vcf"
bucket_name <- "genomics-public-data"
con <- gcs_connection(
    description = file_name, open = "rp", bucket = bucket_name
)
readLines(con, n = 4L)
close(con)
```
The above code can create the same connection as the previous
example. Note that if both link and bucket name are provided, the
bucket name will be ignored. 

For the write connection, it can be made by specifying an appropriate
open mode in the `gcs_connection` function. Please note that due to
the limitation of the Google Cloud Storage, the write connection is
not seekable, which means you cannot use the `seek` function to
navigate through the file. When the write connection is created. 
It always starts in the beginning of the file. If there exist a file 
with the same name, the old file will be deleted. After the write connection is closed, the file will become immutable and no further change on the file 
data can be made.

# Buffer size

For reducing the number of network requests and speeding up the performance 
of the connection, there is a buffer associated with each connection. The default
size is 1Mb for a buffer. You can set or get the buffer size via `gcs_read_buff`,
`gcs_write_buff`, `gcs_get_read_buff` and `gcs_get_write_buff` functions:
```{r}
gcs_get_read_buff()
gcs_get_write_buff()
```
Please note the minimum buffer size for a write connection is 256 Kb. Creating a connection with small buffer size may impact the performance.

